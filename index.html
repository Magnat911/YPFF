<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>AI Receptionist - LiveKit Voice Call</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: white;
    }
    .container {
      text-align: center;
      max-width: 500px;
      padding: 2rem;
    }
    h1 {
      font-size: 3rem;
      font-weight: 800;
      margin-bottom: 1rem;
      background: linear-gradient(45deg, #fff, #f0f0f0);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    p {
      font-size: 1.2rem;
      margin-bottom: 2rem;
      opacity: 0.9;
    }
    #callBtn {
      background: #10b981;
      color: white;
      border: none;
      padding: 1rem 2rem;
      font-size: 1.2rem;
      font-weight: 600;
      border-radius: 9999px;
      cursor: pointer;
      box-shadow: 0 10px 30px rgba(16, 185, 129, 0.4);
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 0.75rem;
      margin: 0 auto;
    }
    #callBtn:hover:not(:disabled) {
      background: #059669;
      transform: translateY(-2px);
      box-shadow: 0 15px 40px rgba(16, 185, 129, 0.6);
    }
    #callBtn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }
    #status {
      margin-top: 1.5rem;
      font-size: 1.1rem;
      font-weight: 500;
      min-height: 1.5rem;
    }
    .phone-icon {
      width: 24px;
      height: 24px;
      stroke: currentColor;
      stroke-width: 2;
    }
    .connecting {
      color: #fbbf24;
    }
    .connected {
      color: #10b981;
    }
    .error {
      color: #ef4444;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>AI Receptionist</h1>
    <p>24/7 voice assistant for realtors. Press to start call.</p>
    
    <button id="callBtn">
      <svg class="phone-icon" fill="none" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 6.375c0 2.278.808 4.476 2.165 6.177l4.488 4.489a3.75 3.75 0 005.304 0l4.488-4.489a11.25 11.25 0 012.165-6.177 3 3 0 00-4.242-4.242l-1.311.311a3 3 0 01-2.121 0l-1.311-.311a3 3 0 00-4.242 4.242z"/>
        <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 9.75L11.25 15.25M15.75 9.75a3 3 0 11-6.262-2.98 9.266 9.266 0 103.966-3.967 3 3 0 11-6.262 2.98"/>
      </svg>
      Call AI Receptionist
    </button>
    
    <div id="status"></div>
  </div>

  <!-- LiveKit Client SDK -->
  <script src="https://cdn.jsdelivr.net/npm/livekit-client@2/dist/livekit-client.umd.min.js"></script>
  
  <script>
    // –¢–í–û–ô –¢–û–ß–ù–´–ô –î–û–ú–ï–ù + /api/token
    const TOKEN_SERVER_URL = "https://ypff-yexksfs2h-nikita1212392-9872s-projects.vercel.app/api/token";
    
    const callBtn = document.getElementById("callBtn");
    const statusEl = document.getElementById("status");
    
    let room = null;
    let localTracks = [];

    async function startCall() {
      try {
        callBtn.disabled = true;
        callBtn.innerHTML = `
          <svg class="phone-icon" fill="none" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
          </svg>
          Connecting...
        `;
        statusEl.textContent = "üîÑ Requesting LiveKit token...";
        statusEl.className = "";

        // 1. –ü–æ–ª—É—á–∞–µ–º —Ç–æ–∫–µ–Ω —Å —Ç–≤–æ–µ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞
        const res = await fetch(TOKEN_SERVER_URL, { 
          method: "POST",
          headers: { "Content-Type": "application/json" }
        });
        
        if (!res.ok) {
          const error = await res.text();
          throw new Error(`Token server error ${res.status}: ${error}`);
        }
        
        const { token, url, roomName } = await res.json();
        console.log("‚úÖ Token received:", { token: token.slice(0, 20) + "...", url, roomName });
        
        statusEl.textContent = "üé§ Connecting microphone...";
        statusEl.className = "connecting";

        // 2. LiveKit SDK
        const { Room, RoomEvent, createLocalTracks, Track } = LivekitClient;
        
        room = new Room({
          adaptiveStream: true,
          dynacast: true,
          videoCaptureDefaults: { 
            facingMode: 'user' 
          }
        });

        // 3. –°–æ–±—ã—Ç–∏—è –∫–æ–º–Ω–∞—Ç—ã
        room
          .on(RoomEvent.Connected, () => {
            console.log("‚úÖ Connected to LiveKit room");
            statusEl.textContent = "‚úÖ Connected. Speak to AI receptionist!";
            statusEl.className = "connected";
          })
          .on(RoomEvent.ParticipantConnected, (participant) => {
            console.log("üë§ Participant connected:", participant.identity);
            if (participant.identity.includes('agent') || participant.identity.includes('Sage')) {
              statusEl.textContent = "ü§ñ AI Receptionist joined the call!";
            }
          })
          .on(RoomEvent.TrackSubscribed, (track, publication, participant) => {
            console.log("üîä Audio track from", participant.identity);
            if (track.kind === Track.Kind.Audio && !track.isLocal) {
              track.attach(); // –ê–≤—Ç–æ-–≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –∞—É–¥–∏–æ –æ—Ç –∞–≥–µ–Ω—Ç–∞
            }
          })
          .on(RoomEvent.Disconnected, (reason) => {
            console.log("‚ùå Disconnected:", reason);
            cleanup();
            statusEl.textContent = "Disconnected from call";
            statusEl.className = "error";
          })
          .on(RoomEvent.ConnectionFailed, (error) => {
            console.error("‚ùå Connection failed:", error);
            cleanup();
            statusEl.textContent = "Connection failed. Check console.";
            statusEl.className = "error";
          });

        // 4. –ú–∏–∫—Ä–æ—Ñ–æ–Ω
        localTracks = await createLocalTracks({
          audio: true,
          video: false,
          echoCancellation: true,
          noiseSuppression: true
        });

        // 5. –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è
        await room.connect(url, token);
        
        // 6. –ü—É–±–ª–∏–∫—É–µ–º –º–∏–∫—Ä–æ—Ñ–æ–Ω
        for (const track of localTracks) {
          await room.localParticipant.publishTrack(track);
          console.log("üéôÔ∏è Published:", track.kind);
        }

      } catch (err) {
        console.error("‚ùå Error:", err);
        statusEl.textContent = `Error: ${err.message}`;
        statusEl.className = "error";
        cleanup();
      }
    }

    function cleanup() {
      if (localTracks) {
        localTracks.forEach(track => track.stop());
        localTracks = [];
      }
      if (room) {
        room.disconnect();
        room = null;
      }
      callBtn.disabled = false;
      callBtn.innerHTML = `
        <svg class="phone-icon" fill="none" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 6.375c0 2.278.808 4.476 2.165 6.177l4.488 4.489a3.75 3.75 0 005.304 0l4.488-4.489a11.25 11.25 0 012.165-6.177 3 3 0 00-4.242-4.242l-1.311.311a3 3 0 01-2.121 0l-1.311-.311a3 3 0 00-4.242 4.242z"/>
          <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 9.75L11.25 15.25M15.75 9.75a3 3 0 11-6.262-2.98 9.266 9.266 0 103.966-3.967 3 3 0 11-6.262 2.98"/>
        </svg>
        Call AI Receptionist
      `;
    }

    // –ö–Ω–æ–ø–∫–∞ toggle
    callBtn.addEventListener("click", () => {
      if (room && room.state === "connected") {
        cleanup();
      } else {
        startCall();
      }
    });

    // –ê–≤—Ç–æ–æ—á–∏—Å—Ç–∫–∞ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    window.addEventListener("beforeunload", cleanup);
  </script>
</body>
</html>
