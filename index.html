<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>AI Receptionist</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body { 
      font-family: system-ui, sans-serif; 
      display: flex; 
      flex-direction: column; 
      align-items: center; 
      justify-content: center; 
      min-height: 100vh; 
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white; 
      margin: 0; 
    }
    .container { text-align: center; padding: 2rem; }
    h1 { font-size: 3rem; font-weight: 800; margin-bottom: 1rem; }
    p { font-size: 1.2rem; margin-bottom: 2rem; opacity: 0.9; }
    #callBtn { 
      background: #10b981; color: white; border: none; 
      padding: 1rem 2rem; font-size: 1.2rem; border-radius: 9999px; 
      cursor: pointer; box-shadow: 0 10px 30px rgba(16,185,129,0.4);
      transition: all 0.3s; 
    }
    #callBtn:hover:not(:disabled) { background: #059669; transform: translateY(-2px); }
    #callBtn:disabled { opacity: 0.6; cursor: not-allowed; }
    #status { margin-top: 1.5rem; font-size: 1.1rem; }
    .connecting { color: #fbbf24; }
    .connected { color: #10b981; }
    .error { color: #ef4444; }
  </style>
</head>
<body>
  <div class="container">
    <h1>ü§ñ AI Receptionist</h1>
    <p>–ù–∞–∂–º–∏ –∫–Ω–æ–ø–∫—É –∏ –≥–æ–≤–æ—Ä–∏ —Å –∞–≥–µ–Ω—Ç–æ–º Sage-1242</p>
    <button id="callBtn">üìû –ü–æ–∑–≤–æ–Ω–∏—Ç—å AI Receptionist</button>
    <div id="status"></div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/livekit-client@2/dist/livekit-client.umd.min.js"></script>
  <script>
    // ‚úÖ –¢–í–û–ô –¢–û–ß–ù–´–ô –î–û–ú–ï–ù –° /api/token
    const TOKEN_SERVER_URL = "https://ypff-yexksfs2h-nikita1212392-9872s-projects.vercel.app/api/token";
    
    const callBtn = document.getElementById("callBtn");
    const statusEl = document.getElementById("status");
    let room = null;
    let localTracks = [];

    async function startCall() {
      try {
        callBtn.disabled = true;
        statusEl.textContent = "üîÑ –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —Ç–æ–∫–µ–Ω...";
        statusEl.className = "connecting";

        // 1. –ü–æ–ª—É—á–∞–µ–º —Ç–æ–∫–µ–Ω —Å –¢–í–û–ï–ì–û —Å–µ—Ä–≤–µ—Ä–∞
        console.log("üì° –ó–∞–ø—Ä–æ—Å —Ç–æ–∫–µ–Ω–∞:", TOKEN_SERVER_URL);
        const res = await fetch(TOKEN_SERVER_URL, { 
          method: "POST",
          headers: { "Content-Type": "application/json" },
          // üöÄ CORS headers –¥–ª—è –æ–±—Ö–æ–¥–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏
          mode: 'cors'
        });
        
        if (!res.ok) {
          const errorText = await res.text();
          throw new Error(`–°–µ—Ä–≤–µ—Ä —Ç–æ–∫–µ–Ω–∞: ${res.status} ${errorText}`);
        }
        
        const data = await res.json();
        console.log("‚úÖ –¢–æ–∫–µ–Ω –ø–æ–ª—É—á–µ–Ω:", data);
        
        statusEl.textContent = "üé§ –ü–æ–¥–∫–ª—é—á–∞–µ–º –º–∏–∫—Ä–æ—Ñ–æ–Ω...";

        // 2. LiveKit –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
        const { Room, RoomEvent, createLocalTracks } = LivekitClient;
        room = new Room();

        room.on(RoomEvent.Connected, () => {
          statusEl.textContent = "‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω! –ì–æ–≤–æ—Ä–∏ —Å –∞–≥–µ–Ω—Ç–æ–º!";
          statusEl.className = "connected";
        });

        room.on(RoomEvent.ParticipantConnected, (p) => {
          console.log("üë§ –ü–æ–¥–∫–ª—é—á–∏–ª—Å—è:", p.identity);
          if (p.identity.includes('agent') || p.identity.includes('Sage')) {
            statusEl.textContent = "ü§ñ Sage-1242 –ø–æ–¥–∫–ª—é—á–∏–ª—Å—è!";
          }
        });

        room.on(RoomEvent.TrackSubscribed, (track) => {
          if (track.kind === 'audio') {
            track.attach(); // –ê—É–¥–∏–æ –æ—Ç –∞–≥–µ–Ω—Ç–∞
          }
        });

        room.on(RoomEvent.Disconnected, cleanup);

        // 3. –ú–∏–∫—Ä–æ—Ñ–æ–Ω
        localTracks = await createLocalTracks({ audio: true, video: false });
        await room.connect(data.url, data.token);

        // 4. –ü—É–±–ª–∏–∫—É–µ–º –º–∏–∫—Ä–æ—Ñ–æ–Ω
        for (const track of localTracks) {
          await room.localParticipant.publishTrack(track);
        }

      } catch (err) {
        console.error("‚ùå –û—à–∏–±–∫–∞:", err);
        statusEl.textContent = `‚ùå ${err.message}`;
        statusEl.className = "error";
        cleanup();
      }
    }

    function cleanup() {
      localTracks.forEach(track => track.stop());
      if (room) room.disconnect();
      room = null;
      localTracks = [];
      callBtn.disabled = false;
      callBtn.textContent = "üìû –ü–æ–∑–≤–æ–Ω–∏—Ç—å AI Receptionist";
      statusEl.textContent = "";
    }

    callBtn.addEventListener("click", () => {
      if (room && room.state === "connected") {
        cleanup();
      } else {
        startCall();
      }
    });
  </script>
</body>
</html>
